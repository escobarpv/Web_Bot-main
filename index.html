<!DOCTYPE html>
<html lang="es" data-bs-theme="auto">
	<head>
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#ced4da">
		<title>KartBot</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js"></script>

    <style>
    body,html{
			height: 100%;
			margin: 0;
      background-image: url("https://i.imgur.com/tHQZkXn.jpeg"); /* The image used */
      background-color: #ffffff; /* Used if the image is unavailable */
      background-position: center; /* Center the image */
      background-repeat: no-repeat; /* Do not repeat the image */
      background-size: cover; /* Resize the background image to cover the entire container */
      /* background-image: linear-gradient(to right top, #22653f, #247448, #268451, #27945a, #28a563, #3bb16f, #4cbd7b, #5cc988, #79d39a, #93dcad, #ace6bf, #c4efd2); */
      /* background-image: -webkit-linear-gradient(to right top, #22653f, #247448, #268451, #27945a, #28a563, #3bb16f, #4cbd7b, #5cc988, #79d39a, #93dcad, #ace6bf, #c4efd2); */
		}
		.chat{
			margin-top: auto;
			margin-bottom: auto;
		}
		.card{
			height: calc(90vh); /* para notebooks */
			border-radius: 15px !important;
			background-color: rgba(0,0,0,0.4) !important;
      border: none !important;
		}
		.contacts_body{
			padding:  0.75rem 0 !important;
			overflow-y: auto;
			white-space: nowrap;
		}
		.msg_card_body{
			overflow-y: auto;
		}
		.card-header{
			border-radius: 15px 15px 0 0 !important;
			border-bottom: 0 !important;
		}
	 .card-footer{
		  border-radius: 0 0 15px 15px !important;
      border-top: 0 !important;
      padding: 10px;
    }
		.container{
			align-content: center;
		}
		.search{
			border-radius: 15px 0 0 15px !important;
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color:white !important;
		}
		.search:focus{
		     box-shadow:none !important;
           outline:0px !important;
		}
		.type_msg{
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color:white !important;
			height: 48px !important;
			overflow-y: auto;
		}
    .type_msg:focus{
      box-shadow:none !important;
      outline:0px !important;
		}
		.text_input_btn{
      border-radius: 10px 0 0 10px !important;
      background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: white !important;
			cursor: text; /* se cambia de pointer a text */
		}
		.send_btn{
	    border-radius: 0 10px 10px 0 !important;
	    background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: #ced4da !important;
			cursor: pointer;
		}
		.search_btn{
			border-radius: 0 15px 15px 0 !important;
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: white !important;
			cursor: pointer;
		}
		.contacts{
			list-style: none;
			padding: 0;
		}
		.contacts li{
			width: 100% !important;
			padding: 5px 10px;
			margin-bottom: 15px !important;
		}
	  .active{
			background-color: rgba(0,0,0,0.3);
	  }
		.user_img{
			height: 70px;
			width: 70px;
			border:1.5px solid #f5f6fa;
      background-color: white;
		}
		.user_img_msg{
			height: 40px;
			width: 40px;
			border:1.5px solid #f5f6fa;
		}
	  .img_cont{
			position: relative;
			height: 70px;
			width: 70px;
    }
    .img_cont_msg{
        height: 40px;
        width: 40px;
    }
    .online_icon{
      position: absolute;
      height: 15px;
      width:15px;
      background-color: #4cd137;
      border-radius: 50%;
      bottom: 0.2em;
      right: 0.4em;
      border:1.5px solid white;
    }
    .offline{
      background-color: #c23616 !important;
    }
    .user_info{
      margin-top: auto;
      margin-left: 15px;
    }
    .user_info span{
      font-size: 20px;
      color: white;
    }
    .user_info p{
    font-size: 10px;
    color: rgba(255,255,255,0.6);
    }
    .video_cam{
      margin-left: 50px;
      margin-top: 5px;
    }
    .video_cam span{
      color: white;
      font-size: 20px;
      cursor: pointer;
      margin-right: 20px;
    }
    .msg_container{
      margin-top: auto;
      margin-bottom: auto;
      margin-left: 10px;
      border-radius: 0 15px 15px 15px;
      background-color: #82ccdd;
      padding: 10px;
      position: relative;
    }
    .msg_container p {
      margin-bottom: 0px !important;
    }
    .msg_container_send{
      margin-top: auto;
      margin-bottom: auto;
      margin-right: 10px;
      border-radius: 15px 0 15px 15px;
      background-color: #78e08f;
      padding: 10px;
      position: relative;
    }
    .msg_time{
      position: absolute;
      left: 0;
      bottom: -15px;
      color: rgba(255,255,255,0.5);
      font-size: 10px;
    }
    .msg_time_send{
      position: absolute;
      right:0;
      bottom: -15px;
      color: rgba(255,255,255,0.5);
      font-size: 10px;
    }
    .msg_head{
      position: relative;
    }
    #action_menu_btn{
      position: absolute;
      right: 10px;
      top: 10px;
      color: white;
      cursor: pointer;
      font-size: 20px;
    }
    .action_menu{
      z-index: 1;
      position: absolute;
      padding: 15px 0;
      background-color: rgba(0,0,0,0.5);
      color: white;
      border-radius: 15px;
      top: 30px;
      right: 15px;
      display: none;
    }
    .action_menu ul{
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .action_menu ul li{
      width: 100%;
      padding: 10px 15px;
      margin-bottom: 5px;
    }
    .action_menu ul li i{
      padding-right: 10px;
    
    }
    .action_menu ul li:hover{
      cursor: pointer;
      background-color: rgba(0,0,0,0.2);
    }
    .logo {
      max-width: 192px;
    }
    .navbar-brand {
        margin-right:0px !important
      }
    @media(max-width: 576px){
      .contacts_card{
        margin-bottom: 15px !important;
      }
    }
    @media(max-width:768px){
      .chat {
        margin-top: 15px !important;
      }
      .card{
			  height: calc(90vh);  /* altura reducida para móviles */
		  }
      .logo {
        max-width: 112px;
      }
    }
    .justify-content-start .msg_container:before {
      content: '';
      display: block;
      position: absolute;
      top: 0;
      border: 18px solid transparent;
      border-top-width: 0;
      left: -28px;
      border-right-color: #82ccdd;
      border-right-width: 16px;
    }
    .justify-content-end .msg_container_send:after {
      content: '';
      display: block;
      position: absolute;
      top: 0;
      border: 18px solid transparent;
      border-top-width: 0;
      right: -28px;
      border-left-color: #78e08f;
      border-left-width: 16px;
    }
    #userInput::placeholder {
    color: #ced4da;
    opacity: 1; /* Firefox */
    }
    #userInput::-ms-input-placeholder { /* Edge 12 -18 */
      color: #ced4da;
    }

    /* Nueva regla para mantener las imágenes del banner en línea y agregar espacio */
    .card-header .container {
        width: 100%;
        display: flex;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
    }

    @media (max-width: 768px) {
        .card-header .container {
            justify-content: center;
            gap: 5px;
        }
    }
    </style>
	</head>

	<body>
    
		<div class="container-fluid h-100">
			<div class="row justify-content-center h-100">
				<div class="col-md-10 col-lg-10 col-xl-8 chat">
					<div class="card">

            <div class="card-header navbar navbar-expand-lg bg-light static-top">
              <div class="container">
                <a class="navbar-brand" href="#">
                  <img class="logo" src="https://i.imgur.com/2L8UmSR.png" alt="...">
                </a>
                <a class="navbar-brand" href="#">
                  <img class="logo" src="https://i.imgur.com/U3QSzo0.png" alt="...">
                </a>
                <a class="navbar-brand" href="#">
                  <img class="logo" src="https://cdn.worldvectorlogo.com/logos/dell-technologies-logo.svg" alt="...">
                </a>
              </div>
            </div>

						<div class="card-header msg_head">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="https://i.imgur.com/Rzi614z.png" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Karting Experience</span>
                  <p>Miércoles 12 de Marzo</p>
								</div>
							</div>
						</div>
						<div id="chat-container" class="card-body msg_card_body">
            </div>
						<div class="card-footer">
							<div class="input-group">
                <input id="userInput" type="text" class="form-control type_msg text_input_btn" placeholder="Escribe un mensaje..."
                  aria-label="Recipient's username" aria-describedby="button-addon2" />
								<div class="input-group-append">
                  <button id="sendBtn" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary send_btn" type="button" id="button-addon2" style="padding-top: .55rem;">
                    Enviar
                  </button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

    <script>
        // Referencia al contenedor del chat
        const chatContainer = document.getElementById('chat-container');
        // Referencia al campo de texto donde se ingresa el mensaje
        const userInput = document.getElementById('userInput');
        // Referencia al botón que enviará el mensaje
        const sendBtn = document.getElementById('sendBtn');

        // Función para eliminar referencias con el formato "【4:1†sostenibilidad_evento.txt】"
        function removeReference(text) {
        return text.replace(/【\d+:\d+†[^】]+】/g, "");
        }

        // Función para crear y añadir un nuevo mensaje al contenedor.
        // Si isAssistant es true, se aplica el estilo del chatbot.
        function addMessage(text, isAssistant = false) {
          const div = document.createElement('div');
          div.className = 'd-flex justify-content-' + (isAssistant ? 'start' : 'end') + ' mb-4';

          const imgCont = document.createElement('div');
          imgCont.className = 'img_cont_msg';

          const img = document.createElement('img');
          img.src = isAssistant 
            ? 'https://static-00.iconduck.com/assets.00/user-avatar-robot-icon-511x512-gi8lbmym.png' 
            : 'https://i.ibb.co/jvf5rMrP/user-avatar-1-256x255.png';
          img.alt = 'avatar';
          img.className = 'rounded-circle user_img_msg';

          imgCont.appendChild(img);

          const msgContainer = document.createElement('div');
          msgContainer.className = isAssistant ? 'msg_container' : 'msg_container_send';
          // Para mensajes del asistente, eliminar la referencia y luego convertir Markdown a HTML
          msgContainer.innerHTML = isAssistant ? marked.parse(removeReference(text)) : text;

          if (isAssistant) {
            div.appendChild(imgCont);
            div.appendChild(msgContainer);
          } else {
            div.appendChild(msgContainer);
            div.appendChild(imgCont);
          }

          chatContainer.appendChild(div);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Función "bot is typing..."
        function showTypingMessage() {
          const typingDiv = document.createElement('div');
          typingDiv.className = 'd-flex justify-content-start mb-4 typingMessage';

          const imgCont = document.createElement('div');
          imgCont.className = 'img_cont_msg';

          const img = document.createElement('img');
          img.src = 'https://static-00.iconduck.com/assets.00/user-avatar-robot-icon-511x512-gi8lbmym.png';
          img.alt = 'avatar';
          img.className = 'rounded-circle user_img_msg';

          imgCont.appendChild(img);

          const msgContainer = document.createElement('div');
          msgContainer.className = 'msg_container';
          msgContainer.textContent = "‎";

          typingDiv.appendChild(imgCont);
          typingDiv.appendChild(msgContainer);

          chatContainer.appendChild(typingDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;

          // Animacion de los puntos
          let dotCount = 0;
          typingInterval = setInterval(() => {
              dotCount = (dotCount + 1) % 4;
              msgContainer.textContent = "‎" + '.'.repeat(dotCount);
          }, 500);
        }

        // Borrar "bot is typing..."
        function removeTypingMessage() {
          const typingMessage = document.querySelector('.typingMessage');
          if (typingMessage) {
              typingMessage.remove();
          }
        }

        // Función que envía el mensaje del usuario y procesa la respuesta.
        function sendMessage() {
          const text = userInput.value.trim();
          if (text !== '') {
            addMessage(text, false); // Publica el mensaje del usuario
            userInput.value = '';

            // Deshabilitar el botón y el campo de entrada
            sendBtn.disabled = true;
            userInput.disabled = true;
            sendBtn.textContent = 'Enviar';

            // Mostrar "bot is typing..." message
            showTypingMessage();

            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            })
            .then(response => response.json())
            .then(data => {
                // Borrar "bot is typing..." message
                removeTypingMessage();
                addMessage(data.reply, true); // Publica el mensaje del asistente
            })
            .catch(error => {
                removeTypingMessage();
                addMessage('Error al comunicarse con el servidor', true);
                console.error('Error:', error);
            })
            .finally(() => {
                // Rehabilitar el botón y el campo de entrada
                sendBtn.disabled = false;
                userInput.disabled = false;
                sendBtn.textContent = 'Enviar';
            });
          }
        }

        // Evento para enviar mensaje cuando se hace clic en el botón
        sendBtn.addEventListener('click', sendMessage);
        // Evento para enviar mensaje al presionar Enter dentro del campo de texto
        userInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
              sendMessage();
          }
        });

        // Mostrar mensaje inicial de bienvenida del asistente
        addMessage(`¡Hola! Soy KartBot, tu asistente oficial del Karting Experience 2025 🏁⚡
Organizado por APC Schneider Electric, Dell y Tecnoglobal.

¿En qué puedo acelerar tu experiencia?

Horarios y ubicación 🕒📍

Bundles exclusivos APC-Dell 💻🔌

Normas de seguridad en pista 🚗🛡️

Menú y transporte 🍸🚌`, true);

    </script>
	</body>
</html>